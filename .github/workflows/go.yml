# SPDX-FileCopyrightText: 2024 Siemens AG
#
# SPDX-License-Identifier: MIT

name: Go

on:
  push:
  pull_request:

permissions:
  contents: write
  packages: write

env:
  GOPRIVATE: github.com/industrial-asset-hub
  GO_MINIMAL_VERSION: 1.24.13
  GO_LINT_VERSION: v2.9
  TEST_PROJECT: cookiecutter-test
  TEST_PROJECT_NAME: test-asset-link
  TEMPLATE_PATH: "cookiecutter-project-template/{{ cookiecutter.al_project }}"
  REGISTRY_IMAGE_URL: ghcr.io/industrial-asset-hub/iah/grpc-server-registry:0.1.14

jobs:
  reuse:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - name: REUSE Compliance Check
        uses: fsfe/reuse-action@v6

  generate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - name: Prepare Environment
        uses: ./.github/actions/prepare
      - name: Generate Code
        run: go generate -v ./...
      - name: Compare Result
        run: git diff --exit-code -w -G'(^[^\*# /])|(^#\w)|(^\s+[^\*#/])'

  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - name: Prepare Environment
        uses: ./.github/actions/prepare
      - name: Lint
        uses: golangci/golangci-lint-action@v9
        with:
          version: ${{ env.GO_LINT_VERSION }}

  autotest:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        feature: ["discover", "identifiers"]
    steps:
      - uses: actions/checkout@v6
      - name: Prepare Environment
        uses: ./.github/actions/prepare
      - name: Install jq
        run: sudo apt-get install -y jq
      - name: Run E2E Tests (${{ matrix.feature }})
        run:  ./autotest.sh ${{ matrix.feature }}

  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - name: Prepare Environment
        uses: ./.github/actions/prepare
      - name: Test
        run: |
          mkdir coverage
          go test ./... -coverprofile=coverage/coverage.out -covermode=atomic -v

  shellcheck:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - name: Prepare Environment
        uses: ./.github/actions/prepare
      - name: Install ShellCheck
        run: sudo apt-get install -y shellcheck
      - name: Run ShellCheck
        run: |
          shellcheck \
            "autotest.sh" \
            "$TEMPLATE_PATH/start-asset-link.sh" \
            "$TEMPLATE_PATH/test-asset-link.sh"

  check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - name: Vulnerability Check
        uses: golang/govulncheck-action@v1
        with:
          go-package: ./...
          repo-checkout: false

  build-sdk:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - name: Prepare Environment
        uses: ./.github/actions/prepare
      - name: Build
        run: go build -v ./...
      - name: Docker Login
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

  build-asset-link:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        go-version: ["1.24.13", "1.25", "stable"]
    steps:
      - uses: actions/checkout@v6
      - name: Prepare Environment
        with:
          go-version: ${{ matrix.go-version }}
        uses: ./.github/actions/prepare
      - name: Install Cookiecutter
        run: |
          python -m pip install pipx
          python -m pipx ensurepath
          pipx install cookiecutter
          export PATH="$PATH:/root/.local/bin"
          cookiecutter --version
      - name: Create Asset Link
        run: |
          mkdir -p $TEST_PROJECT/
          cd $TEST_PROJECT/
          cookiecutter $GITHUB_WORKSPACE/cookiecutter-project-template/ --replay --replay-file $GITHUB_WORKSPACE/cookiecutter-project-template/cookiecutter-project-template.json
      - name: Adjust Dependencies
        run: |
          cd $TEST_PROJECT/$TEST_PROJECT_NAME/
          go get github.com/${GITHUB_REPOSITORY}/v3
          go mod edit -replace=github.com/${GITHUB_REPOSITORY}/v3=${GITHUB_WORKSPACE}
          go mod edit -go=$GO_MINIMAL_VERSION
          go mod edit -toolchain=none
          go mod tidy
          go mod download
      - name: Build Asset Link
        run: |
          cd $TEST_PROJECT/$TEST_PROJECT_NAME/
          go build -v ./...
      - name: Test Asset Link
        run: |
          cd $TEST_PROJECT/$TEST_PROJECT_NAME/
          go test -v ./...
      - name: Lint Asset Link
        uses: golangci/golangci-lint-action@v9
        with:
          version: ${{ env.GO_LINT_VERSION }}
          working-directory: ${{ env.TEST_PROJECT }}/${{ env.TEST_PROJECT_NAME }}/
      - name: Build al-ctl Tool and Install LinkML
        run: |
          go build -o $TEST_PROJECT/$TEST_PROJECT_NAME/al-ctl ./cmd/al-ctl/al-ctl.go
          pip install --upgrade argcomplete
          pip install linkml-validator
      - name: Login to Docker Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Pull gRPC Server Registry Image
        run: docker pull ${{ env.REGISTRY_IMAGE_URL }}
      - name: Run gRPC Server Registry
        run: docker run -d --name grpc-server-registry -p 50051:50051 ${{ env.REGISTRY_IMAGE_URL }}
      - name: Wait for gRPC Server Registry to Start
        run: timeout 30s bash -c 'until nc -z localhost 50051; do sleep 10; done'
      - name: Run Asset Link Test (discover)
        run: $TEST_PROJECT/$TEST_PROJECT_NAME/test-asset-link.sh discover
      - name: Run Asset Link Test (registration)
        run: $TEST_PROJECT/$TEST_PROJECT_NAME/test-asset-link.sh registration
      - name: Run Asset Link Test (validate-asset) -> allowed to fail
        continue-on-error: true
        run: $TEST_PROJECT/$TEST_PROJECT_NAME/test-asset-link.sh validate-asset
      - name: Run Asset Link Test (discovery-api)
        run: $TEST_PROJECT/$TEST_PROJECT_NAME/test-asset-link.sh discovery-api
      - name: Test GoReleaser Config (dry-run)
        uses: goreleaser/goreleaser-action@v6
        with:
          distribution: goreleaser
          version: "~> v2"
          workdir: ${{ env.TEST_PROJECT }}/${{ env.TEST_PROJECT_NAME }}/
          args: release --clean --snapshot

  generate-sbom:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - name: Prepare Environment
        uses: ./.github/actions/prepare
      - name: Generate SBOM
        run: cyclonedx-gomod mod -licenses -type library -test -json -output assetlinksdk.cyclonedx.sbom.json
      - name: Upload SBOM
        uses: actions/upload-artifact@v6
        with:
          name: assetlinksdk.cyclonedx.sbom.json
          path: assetlinksdk.cyclonedx.sbom.json

  release-sdk:
    runs-on: ubuntu-latest
    needs:
      - reuse
      - generate
      - lint
      - test
      - check
      - shellcheck
      - build-sdk
      - build-asset-link
      - generate-sbom
      - autotest
    if: github.event_name != 'pull_request' && github.ref_type == 'tag'
    steps:
      - uses: actions/checkout@v6
      - name: Prepare Environment
        uses: ./.github/actions/prepare
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
      - name: Login to GitHub Container Registry (GHCR.io)
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Release (official)
        uses: goreleaser/goreleaser-action@v6
        with:
          distribution: goreleaser
          version: "~> v2"
          args: release --clean
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  release-sdk-dry-run:
    runs-on: ubuntu-latest
    needs:
      - reuse
      - generate
      - lint
      - test
      - check
      - shellcheck
      - build-sdk
      - build-asset-link
      - generate-sbom
      - autotest
    if: github.event_name == 'pull_request' || github.ref_type != 'tag'
    steps:
      - uses: actions/checkout@v6
      - name: Prepare Environment
        uses: ./.github/actions/prepare
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
      - name: Release (dry-run)
        uses: goreleaser/goreleaser-action@v6
        with:
          distribution: goreleaser
          version: "~> v2"
          args: release --clean --snapshot
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
