# SPDX-FileCopyrightText: 2023 Siemens AG
#
# SPDX-License-Identifier:

include:
  - project: "common-device-management/utils/templates/gitlab-ci"
    ref: main
    file: "shared/base.yaml"
  - project: "common-device-management/utils/templates/gitlab-ci"
    ref: main
    file: "shared/pre-commit.yaml"

stages:
  - check
  - version
  - lint
  - test
  - build
  - release

variables:
  https_proxy: $CODE_PROXY
  http_proxy: $CODE_PROXY
  no_proxy: $CODE_NO_PROXY
  HTTP_PROXY: "$CODE_PROXY"
  HTTPS_PROXY: "$CODE_PROXY"
  NO_PROXY: $CODE_NO_PROXY
  GO_BUILD_IMAGE: golang:1.20.0-alpine
  CGO_ENABLED: 0
  COOKIECUTTER_PROJECT: cookiecutter-test/

# sets credentials to access private GO modules located in code.siemens.com
.set_git_https_credentials: &set_git_https_credentials |
  git config --global url."https://gitlab-ci-token:${CI_JOB_TOKEN}@code.siemens.com/".insteadOf https://code.siemens.com/

# Lint
lint:
  image: $GO_BUILD_IMAGE
  stage: lint
  variables:
    GOLANGCILINT_VERSION: "v1.51.2"
  before_script:
    - apk add --no-cache ca-certificates git jq bash curl
    - echo -e "machine code.siemens.com\nlogin gitlab-ci-token\npassword ${CI_JOB_TOKEN}" > ~/.netrc
    - UPSTREAM_URL=https://raw.githubusercontent.com/golangci/golangci-lint/master/install.sh
    - export BINDIR=/usr/local/bin
    - go install github.com/golangci/golangci-lint/cmd/golangci-lint@$GOLANGCILINT_VERSION
  script:
    - golangci-lint run --out-format code-climate | tee code-quality-report.json | jq -r '.[] | "\(.location.path):\(.location.lines.begin) \(.description)"'
  artifacts:
    reports:
      codequality: code-quality-report.json
    paths:
      - code-quality-report.json
  allow_failure: true

reuse:
  stage: lint
  needs: []
  image:
    name: fsfe/reuse:latest
    entrypoint: [""]
  script:
    - reuse lint
  allow_failure: true

unit-tests:
  stage: test
  needs: []
  image: $GO_BUILD_IMAGE
  variables:
    CGO_ENABLED: 1
  script:
    - apk add --no-cache git curl gcc libc-dev
    - *set_git_https_credentials
    - go test --race ./... -covermode=atomic -coverprofile=coverage.txt -v
    - go tool cover -func=coverage.txt
    - go tool cover -html=coverage.txt -o coverage.html
  artifacts:
    expire_in: 1 day
    paths:
      - coverage.txt
      - coverage.html

cookiecutter-setup:
  stage: test
  needs: []
  image: cr.siemens.com/code-ops/poetry-docker:1.3-py3.11
  variables:
    GIT_STRATEGY: clone
  before_script:
    - python -m pip install pipx
    - python -m pipx ensurepath
    - pipx install cookiecutter
    - source ~/.bashrc
    - cookiecutter --version
  script:
    # Copy pre-defined cookiecutter replay template
    - mkdir -p ~/.cookiecutter_replay/
    - cp ${CI_PROJECT_DIR}/cookiecutter-project-template/cookiecutter-project-template.json ~/.cookiecutter_replay/cookiecutter-project-template.json
    - mkdir ${COOKIECUTTER_PROJECT}
    - cd ${COOKIECUTTER_PROJECT}
    - cookiecutter ${CI_PROJECT_DIR}/cookiecutter-project-template/ --replay
    # directory to the config.yaml used by cookiecutter
    - cd dcd-test/
    - ls
  cache:
    key: "$CI_PIPELINE_ID-$CI_COMMIT_REF_SLUG"
    paths:
      - $COOKIECUTTER_PROJECT
    policy: pull-push

cookiecutter-build:
  stage: build
  image: archlinux:latest
  variables:
    GIT_STRATEGY: clone
    GONOSUMDB: code.siemens.com
    GOPRIVATE: code.siemens.com
  before_script:
    - pacman -Syu --noconfirm
    - pacman -S --noconfirm go zig goreleaser git
  script:
    - echo -e "machine code.siemens.com\nlogin gitlab-ci-token\npassword ${CI_JOB_TOKEN}" > ~/.netrc
    - cd ${COOKIECUTTER_PROJECT}/dcd-test/
    - goreleaser build --snapshot --rm-dist --single-target
  cache:
    key: "$CI_PIPELINE_ID-$CI_COMMIT_REF_SLUG"
    paths:
      - $COOKIECUTTER_PROJECT
  allow_failure: true

build:
  stage: build
  image: archlinux:latest
  before_script:
    - pacman -Syu --noconfirm
    - pacman -S --noconfirm go zig goreleaser git
  script:
    - *set_git_https_credentials
    - goreleaser build --snapshot --rm-dist --single-target
  artifacts:
    expire_in: 1 day
    paths: [dist]

create-release:
  stage: release
  image: archlinux:latest
  # disable artifact passing
  dependencies: []
  variables:
    # Disable shallow cloning so that goreleaser can diff between tags
    GIT_DEPTH: 0
  before_script:
    - pacman -Syu --noconfirm
    - pacman -S --noconfirm go zig goreleaser git git-lfs
    - git lfs install
    - git submodule update
  script:
    - echo -e "machine code.siemens.com\nlogin gitlab-ci-token\npassword ${CI_JOB_TOKEN}" > ~/.netrc
    - |
      if [ "${CI_COMMIT_TAG:-}" != "" ]; then
          export GITLAB_TOKEN="$GITLAB_RELEASE_TOKEN"
          echo "*** Creating official release ***"
          goreleaser release --rm-dist
      else
          echo "*** Creating dry-run release ***"
          goreleaser release --rm-dist --snapshot
      fi
  artifacts:
    expire_in: 1 day
    paths:
      - dist
